import React, { useState, useEffect, useMemo } from 'react';
import { 
    PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Legend, Treemap,
    RadialBarChart, RadialBar, Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis
} from 'recharts';
import { 
    Wallet, Plus, Trash2, Edit2, DollarSign, 
    LayoutDashboard, Database, Search, ArrowLeft, Save, TrendingUp, Globe,
    Sparkles, Loader2, BrainCircuit, X, Settings, History, Eye, Filter, ArrowUpDown, Palette
} from 'lucide-react';

// --- הגדרות ברירת מחדל מעודכנות ---
const DEFAULT_PLATFORMS = [
    { name: "פסגות", color: "#EF4444" },
    { name: "מיטב", color: "#F97316" },
    { name: "בנק הפועלים", color: "#EF4444" },
    { name: "Binance", color: "#F59E0B" },
    { name: "Bybit", color: "#141414" },
    { name: "Exodus", color: "#6366F1" },
    { name: "Blink", color: "#10B981" },
    { name: "אחר", color: "#94A3B8" }
];

const DEFAULT_INSTRUMENTS = [
    { name: "מזומן (ILS)", color: "#10B981" },
    { name: "מזומן (USD)", color: "#22C55E" },
    { name: "מניה בודדת", color: "#3B82F6" },
    { name: "קרן סל (ETF)", color: "#6366F1" },
    { name: "קרן נאמנות", color: "#8B5CF6" },
    { name: "קרן כספית", color: "#A855F7" },
    { name: "Bitcoin", color: "#F59E0B" },
    { name: "Ethereum", color: "#6366F1" },
    { name: "קרן השתלמות", color: "#F43F5E" },
    { name: "פנסיה", color: "#8B5CF6" },
    { name: "נדלן", color: "#A8A29E" },
    { name: "אחר", color: "#64748B" }
];

const DEFAULT_CATEGORIES = [
    { name: "מניות", color: "#3B82F6" },
    { name: "קריפטו", color: "#F59E0B" },
    { name: "מזומן", color: "#10B981" },
    { name: "נדלן", color: "#8B5CF6" },
    { name: "אחר", color: "#64748B" }
];

// --- אינטגרציה עם Gemini API ---
const callGeminiAI = async (prompt) => {
    const apiKey = ""; 
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
            })
        });
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text || "לא התקבלה תשובה תקינה.";
    } catch (error) {
        console.error("Gemini API Error:", error);
        return "שגיאה בתקשורת עם השרת.";
    }
};

// --- שירות מט"ח ---
const fetchExchangeRate = async () => {
    try {
        const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
        const data = await res.json();
        return { rate: data.rates.ILS, date: data.date };
    } catch (e) {
        console.error("Failed to fetch rates", e);
        return null;
    }
};

// --- נתונים התחלתיים ---
const INITIAL_DATA = [
    { id: 1, name: "יתרה בפסגות", platform: "פסגות", category: "מזומן", instrument: "מזומן (ILS)", currency: "ILS", originalValue: 47033, value: 47033, tags: ["נזיל", "לא מושקע"] },
    { id: 2, name: "Invesco Russell 2000", platform: "פסגות", category: "מניות", instrument: "קרן סל (ETF)", currency: "ILS", originalValue: 2874, value: 2874, tags: ["ארהב", "Small Cap", "מדד"] },
    { id: 3, name: "Invesco MSCI World", platform: "פסגות", category: "מניות", instrument: "קרן סל (ETF)", currency: "ILS", originalValue: 2700, value: 2700, tags: ["עולמי", "מפוזר", "מדד"] },
    { id: 4, name: "Buying Power", platform: "Blink", category: "מזומן", instrument: "מזומן (USD)", currency: "USD", originalValue: 2181, value: 2181 * 3.6, tags: ["מטח", "נזיל", "חול"] },
    { id: 5, name: "S&P Energy ETF", platform: "פסגות", category: "מניות", instrument: "קרן סל (ETF)", currency: "ILS", originalValue: 1434, value: 1434, tags: ["ארהב", "סקטוריאלי", "אנרגיה"] },
    { id: 6, name: "OKLO Stock", platform: "פסגות", category: "מניות", instrument: "מניה בודדת", currency: "ILS", originalValue: 491, value: 491, tags: ["גרעין", "ספקולטיבי"] },
    { id: 7, name: "תכלית Ethereum", platform: "פסגות", category: "קריפטו", instrument: "קרן סל (ETF)", currency: "ILS", originalValue: 1693, value: 1693, tags: ["ETH", "שוק ההון"] },
    { id: 8, name: "תכלית Bitcoin", platform: "פסגות", category: "קריפטו", instrument: "קרן סל (ETF)", currency: "ILS", originalValue: 1254, value: 1254, tags: ["BTC", "שוק ההון"] },
    { id: 9, name: "קרן כספית איילון", platform: "בנק הפועלים", category: "מזומן", instrument: "קרן כספית", currency: "ILS", originalValue: 30115, value: 30115, tags: ["סולידי", "נזיל", "תחליף פיקדון"] },
    { id: 10, name: "מניית בנק הפועלים", platform: "בנק הפועלים", category: "מניות", instrument: "מניה בודדת", currency: "ILS", originalValue: 285, value: 285, tags: ["ישראל", "בנקים"] },
    { id: 11, name: "קרן השתלמות", platform: "מיטב", category: "מניות", instrument: "קרן השתלמות", currency: "ILS", originalValue: 7400, value: 7400, tags: ["פנסיוני", "ארהב", "מדד", "S&P 500"] },
    { id: 12, name: "הפקדה בתהליך", platform: "מיטב", category: "מזומן", instrument: "מזומן (ILS)", currency: "ILS", originalValue: 21240, value: 21240, tags: ["נזיל", "פנסיוני"] },
    { id: 13, name: "Tonkeeper Wallet", platform: "אחר", category: "קריפטו", instrument: "אחר", currency: "USD", originalValue: 1210, value: 1210 * 3.6, tags: ["TON", "ארנק פרטי"] },
    { id: 14, name: "Bybit Staking", platform: "Bybit", category: "קריפטו", instrument: "אחר", currency: "USD", originalValue: 979, value: 979 * 3.6, tags: ["Staking", "בורסה", "תשואה", "USDT"] },
    { id: 15, name: "Exodus Wallet", platform: "Exodus", category: "קריפטו", instrument: "אחר", currency: "USD", originalValue: 260, value: 260 * 3.6, tags: ["SOL", "ארנק פרטי"] }
];

const MarkdownRenderer = ({ content }) => {
    if (!content) return null;
    const lines = content.split('\n');
    return (
        <div className="space-y-3 font-sans text-slate-700 leading-relaxed">
            {lines.map((line, idx) => {
                if (line.startsWith('## ')) return <h2 key={idx} className="text-xl font-bold text-slate-800 mt-4 border-b border-slate-200 pb-2">{line.replace('## ', '')}</h2>;
                if (line.startsWith('### ')) return <h3 key={idx} className="text-lg font-bold text-slate-800 mt-3">{line.replace('### ', '')}</h3>;
                if (line.startsWith('* ') || line.startsWith('- ')) {
                    const cleanLine = line.replace(/^[*|-] /, '');
                    const parts = cleanLine.split(/(\*\*.*?\*\*)/g);
                    return (
                        <div key={idx} className="flex gap-2 items-start">
                            <span className="text-purple-500 mt-1.5">•</span>
                            <span>
                                {parts.map((part, i) => 
                                    part.startsWith('**') && part.endsWith('**') 
                                    ? <strong key={i} className="text-slate-900 font-bold">{part.slice(2, -2)}</strong> 
                                    : part
                                )}
                            </span>
                        </div>
                    );
                }
                if (line.trim() === '') return <br key={idx} />;
                const parts = line.split(/(\*\*.*?\*\*)/g);
                return (
                    <p key={idx}>
                        {parts.map((part, i) => 
                            part.startsWith('**') && part.endsWith('**') 
                            ? <strong key={i} className="text-slate-900 font-bold">{part.slice(2, -2)}</strong> 
                            : part
                        )}
                    </p>
                );
            })}
        </div>
    );
};

const Modal = ({ isOpen, onClose, title, children }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" onClick={onClose}>
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                <div className="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                    <h3 className="text-2xl font-bold text-slate-800">{title}</h3>
                    <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full transition text-slate-500">
                        <X size={24} />
                    </button>
                </div>
                <div className="p-6">
                    {children}
                </div>
            </div>
        </div>
    );
};

// --- דשבורד משופר ---
const DashboardView = ({ totalWealth, dataByCategory, dataByTag, dataByInstrument, dataByPlatform, dataByCurrency, systemData }) => {
    const CustomTooltip = ({ active, payload, label }) => {
        if (active && payload && payload.length) {
            const val = payload[0].value;
            const name = payload[0].name || label;
            return (
                <div className="bg-white p-3 border border-slate-100 shadow-lg rounded-lg text-right" dir="rtl">
                    <p className="font-bold text-slate-800 mb-1">{name}</p>
                    <p className="text-emerald-600 font-medium">₪{val.toLocaleString()}</p>
                </div>
            );
        }
        return null;
    };

    const treemapData = dataByPlatform.map(p => ({
        name: p.name,
        size: p.value,
        fill: systemData.platforms.find(sysP => sysP.name === p.name)?.color || '#94a3b8'
    }));

    const radarData = dataByCategory.map(c => ({
        subject: c.name,
        A: c.value,
        fullMark: Math.max(...dataByCategory.map(d => d.value))
    }));

    return (
        <div className="space-y-6 max-w-7xl mx-auto pb-10">
            <header className="mb-6 flex justify-between items-end">
                <div>
                    <h2 className="text-3xl font-bold text-slate-800">דשבורד ראשי</h2>
                    <p className="text-slate-500">תמונת מצב עדכנית ומגוונת</p>
                </div>
                <div className="text-left hidden md:block">
                    <div className="text-sm text-slate-400">שווי נקי</div>
                    <div className="text-3xl font-black text-slate-800 font-mono">₪{totalWealth.toLocaleString()}</div>
                </div>
            </header>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 className="text-lg font-bold text-slate-800 mb-6">פיזור לפי קטגוריות (Radial)</h3>
                    <div className="h-80">
                        <ResponsiveContainer width="100%" height="100%">
                            <RadialBarChart cx="50%" cy="50%" innerRadius="10%" outerRadius="80%" barSize={20} data={dataByCategory}>
                                <RadialBar
                                    label={{ position: 'insideStart', fill: '#fff', fontSize: 10 }}
                                    background
                                    dataKey="value"
                                >
                                    {dataByCategory.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={systemData.categories.find(c => c.name === entry.name)?.color || '#3b82f6'} />
                                    ))}
                                </RadialBar>
                                <Legend iconSize={10} layout="vertical" verticalAlign="middle" wrapperStyle={{right: 0}} />
                                <Tooltip content={<CustomTooltip />} />
                            </RadialBarChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 className="text-lg font-bold text-slate-800 mb-6">מפת איזון תיק (Radar)</h3>
                    <div className="h-80">
                        <ResponsiveContainer width="100%" height="100%">
                            <RadarChart cx="50%" cy="50%" outerRadius="80%" data={radarData}>
                                <PolarGrid />
                                <PolarAngleAxis dataKey="subject" />
                                <PolarRadiusAxis />
                                <Radar name="התיק שלי" dataKey="A" stroke="#8884d8" fill="#8884d8" fillOpacity={0.6} />
                                <Tooltip />
                            </RadarChart>
                        </ResponsiveContainer>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 className="text-lg font-bold text-slate-800 mb-4">מפת גודל נכסים (Treemap)</h3>
                    <div className="h-64">
                        <ResponsiveContainer width="100%" height="100%">
                            <Treemap
                                data={treemapData}
                                dataKey="size"
                                aspectRatio={4 / 3}
                                stroke="#fff"
                                content={<CustomTreemapContent />}
                            >
                                <Tooltip content={<CustomTooltip />} />
                            </Treemap>
                        </ResponsiveContainer>
                    </div>
                </div>

                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 className="text-lg font-bold text-slate-800 mb-6">במה מושקע הכסף? (Instruments)</h3>
                    <div className="h-64">
                        <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={dataByInstrument} margin={{ bottom: 20 }}>
                                <XAxis dataKey="name" tick={{fontSize: 10}} interval={0} height={40} />
                                <YAxis hide />
                                <Tooltip content={<CustomTooltip />} cursor={{fill: '#f8fafc'}} />
                                <Bar dataKey="value" radius={[4, 4, 0, 0]}>
                                    {dataByInstrument.map((entry, index) => (
                                        <Cell key={`cell-${index}`} fill={systemData.instruments.find(i => i.name === entry.name)?.color || '#3b82f6'} />
                                    ))}
                                </Bar>
                            </BarChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            </div>
        </div>
    );
};

const CustomTreemapContent = (props) => {
    const { x, y, width, height, name, size } = props;
    if (width < 40 || height < 30) return null;
    return (
        <g>
            <rect x={x} y={y} width={width} height={height} style={{ fill: props.fill, stroke: '#fff', strokeWidth: 2 }} />
            <text x={x + width / 2} y={y + height / 2} textAnchor="middle" fill="#fff" fontSize={12} fontWeight="bold">
                {name}
            </text>
        </g>
    );
};

// --- יועץ AI משודרג ---
const AIAdvisorView = ({ assets, totalWealth }) => {
    const [loading, setLoading] = useState(false);
    const [history, setHistory] = useState(() => {
        try { return JSON.parse(localStorage.getItem('my_wealth_reports_history')) || []; } 
        catch { return []; }
    });
    const [currentReport, setCurrentReport] = useState(history.length > 0 ? history[0] : null);

    useEffect(() => {
        localStorage.setItem('my_wealth_reports_history', JSON.stringify(history));
    }, [history]);

    const handleAnalyze = async () => {
        setLoading(true);
        const assetsSummary = assets.map(a => 
            `- ${a.name} (${a.instrument} ב-${a.platform}): ₪${a.value.toLocaleString()}`
        ).join('\n');
        
        const prompt = `
        אתה יועץ השקעות. שווי תיק: ₪${totalWealth.toLocaleString()}.
        נכסים:
        ${assetsSummary}
        
        החזר דוח בעברית (Markdown):
        **כותרות**, רשימות, ניתוח סיכונים והמלצות.
        `;

        const result = await callGeminiAI(prompt);
        const newReport = { id: Date.now(), date: new Date().toLocaleDateString('he-IL'), content: result };
        
        const updatedHistory = [newReport, ...history].slice(0, 5); 
        setHistory(updatedHistory);
        setCurrentReport(newReport);
        setLoading(false);
    };

    return (
        <div className="max-w-4xl mx-auto space-y-6 pb-12">
            <header className="mb-6 flex justify-between items-center">
                <div>
                    <h2 className="text-3xl font-bold text-slate-800 flex items-center gap-2">
                        <Sparkles className="text-purple-600" size={32} />
                        יועץ השקעות (AI)
                    </h2>
                </div>
                <button 
                    onClick={handleAnalyze} 
                    disabled={loading}
                    className="bg-purple-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-purple-200 hover:bg-purple-700 transition flex items-center gap-2 disabled:opacity-70"
                >
                    {loading ? <Loader2 size={20} className="animate-spin" /> : <Plus size={20} />}
                    צור דוח חדש
                </button>
            </header>

            {history.length > 0 && (
                <div className="flex gap-2 overflow-x-auto pb-4">
                    {history.map(report => (
                        <button
                            key={report.id}
                            onClick={() => setCurrentReport(report)}
                            className={`px-4 py-2 rounded-lg text-sm border whitespace-nowrap flex items-center gap-2 transition
                                ${currentReport?.id === report.id 
                                    ? 'bg-purple-50 border-purple-500 text-purple-700 font-bold' 
                                    : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}`}
                        >
                            <History size={14} /> {report.date}
                        </button>
                    ))}
                </div>
            )}

            {currentReport ? (
                <div className="bg-white p-8 md:p-12 rounded-xl shadow-lg border border-slate-200 relative min-h-[500px] animate-fade-in">
                    <MarkdownRenderer content={currentReport.content} />
                </div>
            ) : (
                <div className="text-center p-12 text-slate-400 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                    לחץ על "צור דוח חדש" כדי להתחיל
                </div>
            )}
        </div>
    );
};

// --- מסך הגדרות מערכת (כולל קטגוריות) ---
const SettingsView = ({ systemData, setSystemData, currencyRate }) => {
    const handleAdd = (type, name, color) => {
        if (!name) return;
        setSystemData(prev => ({
            ...prev,
            [type]: [...prev[type], { name, color: color || '#94a3b8' }]
        }));
    };

    const handleDelete = (type, name) => {
        if (confirm(`למחוק את ${name}?`)) {
            setSystemData(prev => ({
                ...prev,
                [type]: prev[type].filter(item => item.name !== name)
            }));
        }
    };

    const ListEditor = ({ type, data, title }) => {
        const [newName, setNewName] = useState('');
        const [newColor, setNewColor] = useState('#3b82f6');

        return (
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                <h3 className="text-lg font-bold text-slate-800 mb-4">{title}</h3>
                <div className="flex gap-2 mb-4">
                    <input type="color" value={newColor} onChange={e => setNewColor(e.target.value)} className="w-10 h-10 rounded cursor-pointer border-none" />
                    <input 
                        type="text" 
                        value={newName} 
                        onChange={e => setNewName(e.target.value)} 
                        placeholder="שם חדש..."
                        className="flex-1 border border-slate-200 rounded-lg px-3 outline-none"
                    />
                    <button onClick={() => { handleAdd(type, newName, newColor); setNewName(''); }} className="bg-emerald-600 text-white p-2 rounded-lg hover:bg-emerald-700">
                        <Plus size={20} />
                    </button>
                </div>
                <div className="space-y-2 max-h-60 overflow-y-auto">
                    {data.map(item => (
                        <div key={item.name} className="flex items-center justify-between p-2 bg-slate-50 rounded border border-slate-100">
                            <div className="flex items-center gap-3">
                                <div className="w-4 h-4 rounded-full" style={{ backgroundColor: item.color }}></div>
                                <span className="text-slate-700 font-medium">{item.name}</span>
                            </div>
                            <button onClick={() => handleDelete(type, item.name)} className="text-slate-400 hover:text-red-500"><Trash2 size={16}/></button>
                        </div>
                    ))}
                </div>
            </div>
        );
    };

    return (
        <div className="max-w-6xl mx-auto space-y-6 pb-12">
            <header className="mb-6">
                <h2 className="text-3xl font-bold text-slate-800 flex items-center gap-2">
                    <Settings className="text-slate-600" size={32} />
                    ניהול הגדרות מערכת
                </h2>
                <div className="text-slate-500 mt-2 bg-blue-50 w-fit px-3 py-1 rounded-full text-sm">
                    שער דולר: ₪{currencyRate.rate} ({currencyRate.date})
                </div>
            </header>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <ListEditor type="categories" data={systemData.categories} title="קטגוריות (ראשי)" />
                <ListEditor type="platforms" data={systemData.platforms} title="פלטפורמות" />
                <ListEditor type="instruments" data={systemData.instruments} title="מכשירים" />
            </div>
        </div>
    );
};

// --- טופס הוספה/עריכה (משתמש בקטגוריות דינמיות) ---
const AssetFormView = ({ onSave, onCancel, editAsset = null, systemData }) => {
    const [formData, setFormData] = useState({
        name: '',
        instrument: systemData.instruments[0]?.name || '',
        platform: systemData.platforms[0]?.name || '',
        category: systemData.categories[0]?.name || 'אחר',
        currency: 'ILS',
        originalValue: '',
        tags: ''
    });
    const [tagLoading, setTagLoading] = useState(false);

    useEffect(() => {
        if (editAsset) {
            setFormData({
                name: editAsset.name,
                instrument: editAsset.instrument,
                platform: editAsset.platform,
                category: editAsset.category,
                currency: editAsset.currency || 'ILS',
                originalValue: editAsset.originalValue || editAsset.value,
                tags: editAsset.tags.join(', ')
            });
        }
    }, [editAsset]);

    const handleGenerateTags = async () => {
        if (!formData.name) return alert("הזן שם נכס");
        setTagLoading(true);
        const prompt = `החזר רק רשימת תגיות מופרדת בפסיקים עבור הנכס: ${formData.name}.`;
        const result = await callGeminiAI(prompt);
        setFormData(prev => ({ ...prev, tags: result.replace(/\.$/, '') }));
        setTagLoading(false);
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        onSave({
            ...formData,
            originalValue: Number(formData.originalValue),
            tags: formData.tags.split(',').map(t => t.trim()).filter(t => t)
        });
    };

    const currentColor = (type, val) => systemData[type].find(i => i.name === val)?.color;

    return (
        <div className="max-w-3xl mx-auto pb-12">
            <header className="flex items-center gap-4 mb-8">
                <button onClick={onCancel} className="p-2 hover:bg-slate-200 rounded-full transition"><ArrowLeft size={24} /></button>
                <h2 className="text-3xl font-bold text-slate-800">{editAsset ? 'עריכת נכס' : 'הוספת נכס חדש'}</h2>
            </header>
            <form onSubmit={handleSubmit} className="bg-white p-8 rounded-2xl shadow-lg border border-slate-100 space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-2">פלטפורמה</label>
                        <div className="flex items-center gap-2 border rounded-lg p-3 bg-white">
                            <div className="w-4 h-4 rounded-full" style={{ backgroundColor: currentColor('platforms', formData.platform) }}></div>
                            <select className="w-full outline-none bg-transparent" value={formData.platform} onChange={e => setFormData({...formData, platform: e.target.value})}>
                                {systemData.platforms.map(p => <option key={p.name} value={p.name}>{p.name}</option>)}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-2">מכשיר</label>
                        <div className="flex items-center gap-2 border rounded-lg p-3 bg-white">
                            <div className="w-4 h-4 rounded-full" style={{ backgroundColor: currentColor('instruments', formData.instrument) }}></div>
                            <select className="w-full outline-none bg-transparent" value={formData.instrument} onChange={e => setFormData({...formData, instrument: e.target.value})}>
                                {systemData.instruments.map(i => <option key={i.name} value={i.name}>{i.name}</option>)}
                            </select>
                        </div>
                    </div>
                    <div className="md:col-span-2">
                        <label className="block text-sm font-medium text-slate-700 mb-2">שם הנכס</label>
                        <input type="text" required className="w-full p-3 border rounded-lg" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-2">מטבע</label>
                        <select className="w-full p-3 border rounded-lg" value={formData.currency} onChange={e => setFormData({...formData, currency: e.target.value})}>
                            <option value="ILS">₪ שקל</option>
                            <option value="USD">$ דולר</option>
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-2">שווי מקור</label>
                        <input type="number" required className="w-full p-3 border rounded-lg" value={formData.originalValue} onChange={e => setFormData({...formData, originalValue: e.target.value})} />
                    </div>
                     <div className="md:col-span-2">
                        <label className="block text-sm font-medium text-slate-700 mb-2">קטגוריה</label>
                        <div className="flex gap-2 flex-wrap">
                            {systemData.categories.map(cat => (
                                <button 
                                    type="button" 
                                    key={cat.name} 
                                    onClick={() => setFormData({...formData, category: cat.name})} 
                                    className={`px-4 py-2 rounded-full border flex items-center gap-2 transition
                                        ${formData.category === cat.name ? 'bg-slate-800 text-white' : 'bg-white hover:bg-slate-50'}`}
                                >
                                    <div className="w-2 h-2 rounded-full" style={{backgroundColor: cat.color}}></div>
                                    {cat.name}
                                </button>
                            ))}
                        </div>
                    </div>
                    <div className="md:col-span-2">
                         <div className="flex justify-between mb-2">
                            <label className="text-sm font-medium text-slate-700">תגיות</label>
                            <button type="button" onClick={handleGenerateTags} className="text-xs text-purple-600 font-bold flex gap-1 items-center">{tagLoading ? <Loader2 size={12} className="animate-spin"/> : <Sparkles size={12}/>} AI צור</button>
                        </div>
                        <input type="text" className="w-full p-3 border rounded-lg" value={formData.tags} onChange={e => setFormData({...formData, tags: e.target.value})} />
                    </div>
                </div>
                <div className="flex justify-end gap-3 pt-4 border-t">
                    <button type="button" onClick={onCancel} className="px-6 py-2 rounded-lg hover:bg-slate-100">ביטול</button>
                    <button type="submit" className="px-6 py-2 bg-slate-900 text-white rounded-lg">שמור</button>
                </div>
            </form>
        </div>
    );
};

// --- ניהול נכסים מלא (חזר: חיפוש, סינון, מיון) ---
const AssetManagerView = ({ assets, onDelete, onEdit, onNavigateToAdd, systemData }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const [filterPlatform, setFilterPlatform] = useState('all');
    const [filterCategory, setFilterCategory] = useState('all');
    const [sortConfig, setSortConfig] = useState({ key: 'value', direction: 'desc' });
    const [visibleColumns, setVisibleColumns] = useState({ name: true, instrument: true, platform: true, category: true, tags: true, value: true });
    const [colMenuOpen, setColMenuOpen] = useState(false);
    const [selectedAsset, setSelectedAsset] = useState(null);

    // סינון
    const filteredAssets = assets.filter(asset => {
        const matchesSearch = asset.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                              asset.instrument.toLowerCase().includes(searchTerm.toLowerCase()) ||
                              asset.tags.some(t => t.toLowerCase().includes(searchTerm.toLowerCase()));
        const matchesPlatform = filterPlatform === 'all' || asset.platform === filterPlatform;
        const matchesCategory = filterCategory === 'all' || asset.category === filterCategory;
        return matchesSearch && matchesPlatform && matchesCategory;
    });

    // מיון
    const sortedAssets = [...filteredAssets].sort((a, b) => {
        if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'asc' ? -1 : 1;
        if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'asc' ? 1 : -1;
        return 0;
    });

    const handleSort = (key) => {
        let direction = 'asc';
        if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc';
        setSortConfig({ key, direction });
    };

    const formatMoney = (val, curr) => {
        return curr === 'USD' ? `$${val.toLocaleString()}` : `₪${val.toLocaleString()}`;
    };

    return (
        <div className="max-w-7xl mx-auto space-y-6 pb-12">
            <header className="flex justify-between items-end mb-6">
                <h2 className="text-3xl font-bold text-slate-800">ניהול נכסים</h2>
                <div className="flex gap-2">
                     <div className="relative">
                        <button onClick={() => setColMenuOpen(!colMenuOpen)} className="bg-white border px-4 py-3 rounded-lg flex items-center gap-2 hover:bg-slate-50">
                            <Eye size={20} /> תצוגה
                        </button>
                        {colMenuOpen && (
                            <div className="absolute top-12 left-0 bg-white border shadow-xl rounded-lg p-4 z-20 w-48 space-y-2">
                                {Object.keys(visibleColumns).map(key => (
                                    <label key={key} className="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" checked={visibleColumns[key]} onChange={() => setVisibleColumns(prev => ({...prev, [key]: !prev[key]}))} />
                                        {key === 'name' ? 'שם' : key === 'value' ? 'שווי' : key}
                                    </label>
                                ))}
                            </div>
                        )}
                    </div>
                    <button onClick={onNavigateToAdd} className="bg-emerald-600 text-white px-6 py-3 rounded-lg flex items-center gap-2 font-medium hover:bg-emerald-700">
                        <Plus size={20} /> הוסף
                    </button>
                </div>
            </header>

            {/* סרגל כלים: חיפוש ופילטרים */}
            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col md:flex-row gap-4">
                <div className="relative flex-1">
                    <Search className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400" size={20} />
                    <input 
                        type="text" 
                        placeholder="חיפוש חופשי..." 
                        className="w-full pl-4 pr-10 py-2 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none"
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                    />
                </div>
                <div className="flex gap-2">
                    <select className="p-2 border rounded-lg" value={filterCategory} onChange={e => setFilterCategory(e.target.value)}>
                        <option value="all">כל הקטגוריות</option>
                        {systemData.categories.map(c => <option key={c.name} value={c.name}>{c.name}</option>)}
                    </select>
                    <select className="p-2 border rounded-lg" value={filterPlatform} onChange={e => setFilterPlatform(e.target.value)}>
                        <option value="all">כל הפלטפורמות</option>
                        {systemData.platforms.map(p => <option key={p.name} value={p.name}>{p.name}</option>)}
                    </select>
                </div>
            </div>

            {/* טבלה */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="w-full text-sm text-right">
                        <thead className="bg-slate-50 text-slate-600 border-b border-slate-200">
                            <tr>
                                {visibleColumns.name && <th className="p-4 cursor-pointer hover:bg-slate-100" onClick={() => handleSort('name')}>שם הנכס <ArrowUpDown size={12} className="inline"/></th>}
                                {visibleColumns.instrument && <th className="p-4 cursor-pointer hover:bg-slate-100" onClick={() => handleSort('instrument')}>מכשיר</th>}
                                {visibleColumns.platform && <th className="p-4 cursor-pointer hover:bg-slate-100" onClick={() => handleSort('platform')}>פלטפורמה</th>}
                                {visibleColumns.category && <th className="p-4 cursor-pointer hover:bg-slate-100" onClick={() => handleSort('category')}>קטגוריה</th>}
                                {visibleColumns.tags && <th className="p-4">תגיות</th>}
                                {visibleColumns.value && <th className="p-4 cursor-pointer hover:bg-slate-100" onClick={() => handleSort('value')}>שווי <ArrowUpDown size={12} className="inline"/></th>}
                                <th className="p-4 text-center">פעולות</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {sortedAssets.map(asset => (
                                <tr 
                                    key={asset.id} 
                                    className="hover:bg-slate-50 transition cursor-pointer"
                                    onClick={() => setSelectedAsset(asset)}
                                >
                                    {visibleColumns.name && <td className="p-4 font-bold text-slate-700">{asset.name}</td>}
                                    {visibleColumns.instrument && <td className="p-4 text-slate-600">{asset.instrument}</td>}
                                    {visibleColumns.platform && <td className="p-4 text-slate-500">{asset.platform}</td>}
                                    {visibleColumns.category && <td className="p-4"><span className="bg-slate-100 px-2 py-1 rounded-full text-xs">{asset.category}</span></td>}
                                    {visibleColumns.tags && (
                                        <td className="p-4">
                                            <div className="flex gap-1 flex-wrap max-w-[200px]">
                                                {asset.tags.slice(0, 3).map((tag, i) => <span key={i} className="text-xs bg-slate-50 border px-1 rounded">{tag}</span>)}
                                            </div>
                                        </td>
                                    )}
                                    {visibleColumns.value && (
                                        <td className="p-4">
                                            <div className="font-bold">₪{asset.value.toLocaleString()}</div>
                                            <div className="text-xs text-slate-400" dir="ltr">{asset.currency === 'USD' ? '$' : '₪'}{asset.originalValue.toLocaleString()}</div>
                                        </td>
                                    )}
                                    <td className="p-4 flex justify-center gap-2" onClick={e => e.stopPropagation()}>
                                        <button onClick={() => onEdit(asset)} className="p-2 hover:bg-blue-50 text-slate-400 hover:text-blue-500 rounded-full"><Edit2 size={16}/></button>
                                        <button onClick={() => onDelete(asset.id)} className="p-2 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-full"><Trash2 size={16}/></button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>

             {/* מודל פרטים מלאים */}
            <Modal isOpen={!!selectedAsset} onClose={() => setSelectedAsset(null)} title={selectedAsset?.name}>
                {selectedAsset && (
                    <div className="space-y-6">
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-slate-50 p-4 rounded-xl">
                                <div className="text-sm text-slate-500">שווי בשקלים</div>
                                <div className="text-2xl font-bold text-slate-800">₪{selectedAsset.value.toLocaleString()}</div>
                            </div>
                            <div className="bg-slate-50 p-4 rounded-xl">
                                <div className="text-sm text-slate-500">שווי מקור</div>
                                <div className="text-2xl font-bold text-slate-800" dir="ltr">
                                    {formatMoney(selectedAsset.originalValue, selectedAsset.currency)}
                                </div>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <div className="flex border-b border-slate-100 pb-2">
                                <span className="w-1/3 text-slate-500">פלטפורמה</span>
                                <span className="font-medium text-slate-800">{selectedAsset.platform}</span>
                            </div>
                            <div className="flex border-b border-slate-100 pb-2">
                                <span className="w-1/3 text-slate-500">מכשיר</span>
                                <span className="font-medium text-slate-800">{selectedAsset.instrument}</span>
                            </div>
                            <div className="flex border-b border-slate-100 pb-2">
                                <span className="w-1/3 text-slate-500">קטגוריה</span>
                                <span className="font-medium text-slate-800">{selectedAsset.category}</span>
                            </div>
                        </div>

                        <div>
                            <div className="text-sm text-slate-500 mb-2">תגיות משויכות</div>
                            <div className="flex flex-wrap gap-2">
                                {selectedAsset.tags.map((tag, i) => (
                                    <span key={i} className="bg-purple-50 text-purple-700 px-3 py-1 rounded-full text-sm font-medium border border-purple-100">
                                        {tag}
                                    </span>
                                ))}
                            </div>
                        </div>

                        <div className="flex justify-end gap-3 mt-6 pt-4 border-t border-slate-100">
                            <button 
                                onClick={() => {onEdit(selectedAsset); setSelectedAsset(null);}} 
                                className="bg-slate-900 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-slate-800"
                            >
                                <Edit2 size={16}/> ערוך נכס
                            </button>
                        </div>
                    </div>
                )}
            </Modal>
        </div>
    );
};

// --- אפליקציה ראשית ---
export default function App() {
    const [view, setView] = useState('dashboard');
    const [editingAsset, setEditingAsset] = useState(null);
    const [systemData, setSystemData] = useState(() => {
        try { 
            const saved = JSON.parse(localStorage.getItem('my_wealth_system'));
            if (!saved || !saved.categories) return { platforms: DEFAULT_PLATFORMS, instruments: DEFAULT_INSTRUMENTS, categories: DEFAULT_CATEGORIES };
            return saved;
        }
        catch { return { platforms: DEFAULT_PLATFORMS, instruments: DEFAULT_INSTRUMENTS, categories: DEFAULT_CATEGORIES }; }
    });
    const [assets, setAssets] = useState(() => {
        try { return JSON.parse(localStorage.getItem('my_wealth_data_v5')) || INITIAL_DATA; }
        catch { return INITIAL_DATA; }
    });
    const [currencyRate, setCurrencyRate] = useState({ rate: 3.65, date: 'ברירת מחדל' });

    useEffect(() => {
        localStorage.setItem('my_wealth_data_v5', JSON.stringify(assets));
        localStorage.setItem('my_wealth_system', JSON.stringify(systemData));
    }, [assets, systemData]);

    useEffect(() => {
        const loadRates = async () => {
            const savedRate = JSON.parse(localStorage.getItem('currency_rate'));
            const today = new Date().toISOString().split('T')[0];
            if (savedRate && savedRate.date === today) {
                setCurrencyRate(savedRate);
            } else {
                const data = await fetchExchangeRate();
                if (data) {
                    const newRate = { rate: data.rate, date: data.date };
                    setCurrencyRate(newRate);
                    localStorage.setItem('currency_rate', JSON.stringify(newRate));
                }
            }
        };
        loadRates();
    }, []);

    const totalWealth = assets.reduce((sum, item) => sum + (item.currency === 'USD' ? item.originalValue * currencyRate.rate : item.originalValue), 0);
    const recalculateAssets = assets.map(a => ({
        ...a,
        value: a.currency === 'USD' ? a.originalValue * currencyRate.rate : a.originalValue
    }));

    // אגרגציות
    const dataByCategory = useMemo(() => {
        const map = {};
        recalculateAssets.forEach(a => map[a.category] = (map[a.category] || 0) + a.value);
        return Object.keys(map).map(name => ({ name, value: map[name] })).sort((a,b) => b.value - a.value);
    }, [recalculateAssets]);

    const dataByInstrument = useMemo(() => {
        const map = {};
        recalculateAssets.forEach(a => map[a.instrument] = (map[a.instrument] || 0) + a.value);
        return Object.keys(map).map(name => ({ name, value: map[name] })).sort((a,b) => b.value - a.value);
    }, [recalculateAssets]);

    const dataByPlatform = useMemo(() => {
        const map = {};
        recalculateAssets.forEach(a => map[a.platform] = (map[a.platform] || 0) + a.value);
        return Object.keys(map).map(name => ({ name, value: map[name] })).sort((a,b) => b.value - a.value);
    }, [recalculateAssets]);

    const dataByCurrency = useMemo(() => {
        const map = { "ILS": 0, "USD": 0 };
        recalculateAssets.forEach(a => map[a.currency || "ILS"] += a.value);
        return Object.keys(map).map(name => ({ name, value: map[name] }));
    }, [recalculateAssets]);

    const dataByTag = useMemo(() => {
        const map = {};
        recalculateAssets.forEach(a => a.tags.forEach(t => map[t] = (map[t] || 0) + a.value));
        return Object.entries(map).map(([name, value]) => ({ name, value })).sort((a,b) => b.value - a.value).slice(0, 10);
    }, [recalculateAssets]);

    const COLORS = systemData.categories.reduce((acc, cat) => ({...acc, [cat.name]: cat.color}), { "אחר": "#94a3b8" });

    const handleSaveAsset = (asset) => {
        if (asset.id && assets.some(a => a.id === asset.id)) {
            setAssets(assets.map(a => a.id === asset.id ? asset : a));
        } else {
            setAssets([...assets, { ...asset, id: Date.now() }]);
        }
        setEditingAsset(null);
        setView('manage');
    };

    return (
        <div className="min-h-screen flex flex-col md:flex-row bg-slate-50 font-sans text-right" dir="rtl">
            <aside className="w-full md:w-64 bg-slate-900 text-white p-6 flex flex-col shadow-xl z-20 sticky top-0 md:h-screen">
                <h1 className="text-2xl font-bold mb-10 flex items-center gap-2 tracking-tight">
                    <Wallet className="w-8 h-8 text-emerald-400" />
                    MyWealth <span className="text-xs bg-purple-600 px-1.5 py-0.5 rounded text-white flex items-center gap-1"><Sparkles size={10} />PRO</span>
                </h1>
                <nav className="flex-1 space-y-3">
                    <button onClick={() => setView('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition font-medium ${view === 'dashboard' ? 'bg-emerald-600 text-white' : 'hover:bg-slate-800 text-slate-400'}`}><LayoutDashboard size={20} /> דשבורד</button>
                    <button onClick={() => setView('advisor')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition font-medium ${view === 'advisor' ? 'bg-purple-600 text-white' : 'hover:bg-slate-800 text-slate-400'}`}><Sparkles size={20} /> יועץ AI</button>
                    <button onClick={() => setView('manage')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition font-medium ${view === 'manage' ? 'bg-emerald-600 text-white' : 'hover:bg-slate-800 text-slate-400'}`}><Database size={20} /> ניהול נכסים</button>
                    <button onClick={() => setView('add')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition font-medium ${view === 'add' ? 'bg-emerald-600 text-white' : 'hover:bg-slate-800 text-slate-400'}`}><Plus size={20} /> הוספת נכס</button>
                    <button onClick={() => setView('settings')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition font-medium ${view === 'settings' ? 'bg-slate-700 text-white' : 'hover:bg-slate-800 text-slate-400'}`}><Settings size={20} /> הגדרות</button>
                </nav>
                <div className="mt-auto pt-6 border-t border-slate-800">
                     <div className="text-xs text-slate-500 mb-1">סה"כ הון עצמי</div>
                     <div className="text-xl font-bold text-emerald-400">₪{totalWealth.toLocaleString()}</div>
                     <div className="text-xs text-slate-600 mt-2">1$ = ₪{currencyRate.rate}</div>
                </div>
            </aside>

            <main className="flex-1 p-4 md:p-8 overflow-y-auto bg-slate-50/50">
                {view === 'dashboard' && <DashboardView totalWealth={totalWealth} dataByCategory={dataByCategory} dataByTag={dataByTag} dataByInstrument={dataByInstrument} dataByPlatform={dataByPlatform} dataByCurrency={dataByCurrency} systemData={systemData} COLORS={COLORS} />}
                {view === 'advisor' && <AIAdvisorView assets={recalculateAssets} totalWealth={totalWealth} />}
                {view === 'settings' && <SettingsView systemData={systemData} setSystemData={setSystemData} currencyRate={currencyRate} />}
                {view === 'manage' && <AssetManagerView assets={recalculateAssets} onDelete={id => setAssets(assets.filter(a => a.id !== id))} onEdit={a => {setEditingAsset(a); setView('add');}} onNavigateToAdd={() => {setEditingAsset(null); setView('add');}} systemData={systemData} />}
                {view === 'add' && <AssetFormView onSave={handleSaveAsset} onCancel={() => setView('manage')} editAsset={editingAsset} systemData={systemData} />}
            </main>
        </div>
    );
};